--- 
title: "corCTF 2024"
date: 2024-07-30T00:20:31+07:00
description: "Solution for corCTF 2024 challenges"
tag: [pcap,tshark,event log]
categories: [ctf]
author: [1]
---
<!--more-->

## Overview
- Hi guys, it's me again. Three months is long time for me to participate in a CTF tournement that i can write WU for it. Thanks for reading my blog.

## Solution

## 1.The-conspirasy (Forensics)
- Challenge give me 2 files : one is pcap, one is python code. I tried opening the pcap file to see what was there. At first glance, it contained TCP streams containing data in the form [x,y,z ...] with 2 types including numbers less than or equal to 100 and large numbers with 3 or more digits. Read the python code file further. That's a way to encode and send data.

```python
import csv

sources, destinations, messages = [], [], []

with open('chatlogs.csv', mode='r') as file:
    csv_reader = csv.reader(file)
    for row in csv_reader:
        sources.append(row[0])
        destinations.append(row[1])
        messages.append(row[2])

def encrypt(message):
    messagenums = []
    for character in message:
        messagenums.append(ord(character))
    keys = []
    for i in range(len(messagenums)):
        keys.append(random.randint(10, 100))

    finalmessage = []
    for i in range(len(messagenums)):
        finalmessage.append(messagenums[i] * keys[i])

    return keys, finalmessage

for i in range(len(messages)):
    finalmessage, keys = encrypt(messages[i])
    print(finalmessage, keys)
    packet1 = IP(src=sources[i], dst=destinations[i])/TCP(dport=80)/Raw(load=str(finalmessage))
    send(packet1)
    packet2 = IP(src=sources[i], dst=destinations[i])/TCP(dport=80)/Raw(load=str(keys))
    send(packet2)
```

- The code performs three steps:
```
    **1 - Read data from CSV file:**

- Open chatlogs.csv.

- Read rows from CSV file and save values ​​to sources, destinations, and messages.

    **2 - Encrypt function:**

- Convert each character in message to ASCII code and save to messagenums.

- Create a list of keys containing random numbers from 10 to 100.

- Encrypt the message by multiplying each ASCII value in messagenums by the corresponding key in keys.

    **3 - Send encrypted message and encryption key over the network:**

- For each message in messages, encrypt the message.

- Create two packets:

    +  The first packet contains the encrypted message (finalmessage).

    + The second packet contains the encryption keys (keys).

- Send these packets over the network to their respective destinations using Scapy.
```
- To decode and get the original data, we do 2 steps: First, take the encrypted value and divide it by the key to get the original value, then convert the value from the corresponding ASCII value.Extract raw data from pcap file using tshark (I will find a way to filter it faster).

```
tshark -r challenge.pcap -Y "tcp" -T fields -e tcp.payload > chatlogs.csv.
```

- Then simply decode hex, filter them into 2 files and use code to decode them. This my code to filter (after decode hex value).

```python
import re

def process_lines(input_file, file_greater_than_500, file_less_than_or_equal_500):
    with open(input_file, 'r') as file:
        lines = file.readlines()

    with open(file_greater_than_500, 'w') as file1, open(file_less_than_or_equal_500, 'w') as file2:
        for line in lines:
            numbers = re.findall(r'\d+', line)

            if any(int(num) > 500 for num in numbers):
                file1.write(line)
            else:
                file2.write(line)

process_lines('chatlogs.csv', '1.txt', '2.txt')
```

- And this is decrypt code : 

```python
def decrypt(finalmessage, keys):
    original_message = []
    for i in range(len(finalmessage)):
        original_char_code = finalmessage[i] // keys[i]
        original_message.append(chr(original_char_code))
    return ''.join(original_message)

def read_numbers_from_file(filename):
    numbers = []
    with open(filename, 'r') as file:
        for line in file:
            line = line.strip()
            line = line.replace('[', '').replace(']', '').replace(' ', '')
            if line:  
                numbers.extend(map(int, line.split(',')))
    return numbers

finalmessage = read_numbers_from_file('1.txt')
keys = read_numbers_from_file('2.txt')

print(decrypt(finalmessage, keys))
```

- Then we got the flag : 